name: Release

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.1.0 などのタグでトリガー

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # リリース作成に必要
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew build
      
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Get plugin name
      id: get_plugin
      run: |
        PLUGIN_NAME=$(ls build/libs/*Plugin-*.jar | head -1 | basename | sed 's/-[0-9].*//')
        echo "PLUGIN_NAME=$PLUGIN_NAME" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: "${{ steps.get_plugin.outputs.PLUGIN_NAME }} ${{ steps.get_version.outputs.VERSION }}"
        body: |
          ## 📦 ${{ steps.get_plugin.outputs.PLUGIN_NAME }} ${{ steps.get_version.outputs.VERSION }}
          
          ### 🎯 リリース内容
          - バグ修正とパフォーマンス向上
          - 新機能追加
          
          ### 📥 インストール方法
          1. JARファイルをダウンロード
          2. `plugins/` フォルダに配置
          3. サーバーを再起動 または `/plugman load ${{ steps.get_plugin.outputs.PLUGIN_NAME }}`
          
          ### 📋 動作環境
          - **Minecraft**: 1.20.x 以上
          - **Java**: 21 以上
          - **Paper/Spigot**: 最新版推奨
          
          ### 🔗 関連リンク
          - [変更履歴](./CHANGELOG.md)
          - [開発ガイド](./AGENTS.md)
          
        files: |
          build/libs/*.jar
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
