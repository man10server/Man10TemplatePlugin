name: Release

on:
  push:
    tags:
      - 'v*'  # v1.0.0, v1.1.0 ãªã©ã®ã‚¿ã‚°ã§ãƒˆãƒªã‚¬ãƒ¼

jobs:
  release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # ãƒªãƒªãƒ¼ã‚¹ä½œæˆã«å¿…è¦
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Build with Gradle
      run: ./gradlew build
      
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Get plugin name
      id: get_plugin
      run: |
        PLUGIN_NAME=$(ls build/libs/*Plugin-*.jar | head -1 | basename | sed 's/-[0-9].*//')
        echo "PLUGIN_NAME=$PLUGIN_NAME" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.VERSION }}
        name: "${{ steps.get_plugin.outputs.PLUGIN_NAME }} ${{ steps.get_version.outputs.VERSION }}"
        body: |
          ## ğŸ“¦ ${{ steps.get_plugin.outputs.PLUGIN_NAME }} ${{ steps.get_version.outputs.VERSION }}
          
          ### ğŸ¯ ãƒªãƒªãƒ¼ã‚¹å†…å®¹
          - ãƒã‚°ä¿®æ­£ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
          - æ–°æ©Ÿèƒ½è¿½åŠ 
          
          ### ğŸ“¥ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ–¹æ³•
          1. JARãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          2. `plugins/` ãƒ•ã‚©ãƒ«ãƒ€ã«é…ç½®
          3. ã‚µãƒ¼ãƒãƒ¼ã‚’å†èµ·å‹• ã¾ãŸã¯ `/plugman load ${{ steps.get_plugin.outputs.PLUGIN_NAME }}`
          
          ### ğŸ“‹ å‹•ä½œç’°å¢ƒ
          - **Minecraft**: 1.20.x ä»¥ä¸Š
          - **Java**: 21 ä»¥ä¸Š
          - **Paper/Spigot**: æœ€æ–°ç‰ˆæ¨å¥¨
          
          ### ğŸ”— é–¢é€£ãƒªãƒ³ã‚¯
          - [å¤‰æ›´å±¥æ­´](./CHANGELOG.md)
          - [é–‹ç™ºã‚¬ã‚¤ãƒ‰](./AGENTS.md)
          
        files: |
          build/libs/*.jar
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
